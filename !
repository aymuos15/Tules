#!/usr/bin/env python3
"""
! - Ultra-short wrapper for Tules
Makes running background AI agents as simple as: ! your task here
"""
import sys
import subprocess
from pathlib import Path

# Path to Tules.py
TULES = Path(__file__).resolve().parent / 'Tules.py'

# Keywords that should be passed through as commands (not prompts)
KEYWORDS = {'list', 'logs', 'clear', 'kill', 'schedule', 'daemon'}

def show_help():
    """Show custom help message for ! command"""
    help_text = """
! - Ultra-short wrapper for Tules background agent runner

Usage:
  \\! <prompt>              Run task with Claude (default provider)
  \\! !gemini <prompt>      Run task with Gemini
  \\! !claude <prompt>      Run task with Claude (explicit)
  \\! list [--all]          List background agents
  \\! logs <session-id>     View session logs
  \\! clear [--force]       Clear completed sessions
  \\! kill <session-id>     Kill a running agent

Examples:
  \\! fix this bug
  \\! !gemini analyze this codebase
  \\! list --all
  \\! logs abc123

Note: Escape ! in bash as \\! (backslash-exclamation)

For more options, see: Tules --help
"""
    print(help_text)

def main():
    args = sys.argv[1:]

    # Handle help flags
    if not args or args[0] in ['--help', '-h', 'help']:
        show_help()
        return

    # Parse for provider flag (words starting with !)
    provider = None
    prompt_args = []

    for arg in args:
        if arg.startswith('!') and len(arg) > 1:
            # Extract provider from !provider syntax
            provider_name = arg[1:].lower()
            if provider_name in ['claude', 'gemini']:
                provider = provider_name
            else:
                # Not a valid provider, treat as part of prompt
                prompt_args.append(arg)
        else:
            prompt_args.append(arg)

    if not prompt_args:
        print("Error: No command or prompt provided after !provider flag")
        print("Try: \\! --help")
        sys.exit(1)

    # Check if first remaining arg is a keyword command
    if prompt_args[0] in KEYWORDS:
        # Pass through as command to Tules
        cmd = ['python3', str(TULES)]
        if provider:
            cmd += ['--provider', provider]
        cmd += prompt_args
    else:
        # Treat as prompt for 'run' command
        prompt = ' '.join(prompt_args)
        cmd = ['python3', str(TULES)]
        if provider:
            cmd += ['--provider', provider]
        cmd += ['run', prompt]

    # Execute Tules
    subprocess.run(cmd)

if __name__ == '__main__':
    main()
